<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#1271e6">
    <meta property="og:title" content="Standard Ebook Reader" />
    <meta property="og:image" content="https://standardebooks.org/images/logo.png" />
    <meta name="Description" content="Read books from Standard Ebooks">

    <link rel="manifest" href="./manifest.json" />
    <link rel="stylesheet" type="text/css" href="./css/styles.css" media="screen"/>
    <link rel="stylesheet" type="text/css" href="./css/index.css" media="screen"/>
    <link rel="stylesheet" type="text/css" href="./css/ebook.css" media="screen"/>
    
    <script type="module" src="./js/darkMode.js"></script>
    <script src="./lib/jszip.3.5.0.js"></script>
    <script src="./lib/epub.0.3.88.js"></script>

    <title>Standard Ebook Reader</title>
  </head>
  <body>
    <header class="section">
        <div id="myTopBar" class="topbar">
            <p>
                &nbsp;<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            </p>
            <p>&nbsp;<a href="/">Back to Library</a></p>
            <p>&nbsp;<b id="topbar-book-title"></b></p>
            <button id="styles-button" onclick="openStylesModal()">Aa</button>
            <button name="Toggle dark mode" role="button" value="light" id="dark-button" onclick="refreshPage()">&nbsp;</button>
            <label for="tocSelect">Chapter:</label>
            <div class="select">
                <select name="chapter" id="tocSelect"></select>
            </div>
            <p>&nbsp;Page: <span id="topbar-book-page"></span></p>
        </div>
        <div id="openbtn" class="openbtn" onclick="openNav()">&#9776;</div>
    </header>
    <div class="modal" id="stylesModal">
        <div class="modal-content">
            <span class="close" onclick="closeStylesModal()">X</span>
            <p>Font Size: 
              <button class="style-button" onclick="biggerFont()">+</button>
              <button class="style-button" onclick="smallerFont()">-</button>
            </p>
        </div>
    </div>
    <div id="prev" class="left-side">&nbsp;</div>
    <main>
        <div id="loading-cover" class="loading-cover"></div>
        <div id="viewer" class="view"></div>
    </main>
    <div id="next" class="right-side">&nbsp;</div>
    <footer id="footer" class="section"></footer>
    <script>
        const fontSize = 'fontSize-num'
        if(!window.localStorage.getItem(fontSize)) {
            window.localStorage.setItem(fontSize, 0);
        }
        switchOnSize()
        function biggerFont() {
            let size = window.localStorage.getItem(fontSize)
            if (Number(size) == 0 || Number(size) == -1) {
                size++;
                window.localStorage.setItem(fontSize, size);
            }
            switchOnSize()
        }
        function smallerFont() {
            let size = window.localStorage.getItem(fontSize)
            if (Number(size) == 0 || Number(size) == 1) {
                size--;
                window.localStorage.setItem(fontSize, size);
            }
            switchOnSize()
        }
        function switchOnSize() {
            let size = window.localStorage.getItem(fontSize)
            switch(size) {
                case('-1'): {
                    console.log('small')
                    window.localStorage.setItem('fontSize', 'small')
                    break;
                }
                case('0'): {
                    console.log('zero')
                    window.localStorage.setItem('fontSize', 'default')
                    break;
                }
                case('1'): {
                    console.log('large')
                    window.localStorage.setItem('fontSize', 'large')
                    break;
                }
                default: {
                    console.log('default')
                    window.localStorage.setItem('fontSize', 'default')
                    break;
                }
            }
        }
        function openStylesModal() {
            document.getElementById("stylesModal").style.display = "initial";
            // document.getElementById("openbtn").style.display = "none"
        }
        function closeStylesModal() {
            document.getElementById("stylesModal").style.display = "none";
            refreshPage();
        }
        function openNav() {
            document.getElementById("myTopBar").style.display = "initial";
            document.getElementById("openbtn").style.display = "none"
        }

        function closeNav() {
            document.getElementById("myTopBar").style.display = "none";
            document.getElementById("openbtn").style.display = "initial";
        } 
        function refreshPage() {
            window.location.reload(true)
        }
        closeNav()
        const params = (new URL(document.location)).searchParams;
        const bookParam = params.get('book')
        const standardUrl = `https://standardebooks.org`
        const loadingCover = document.getElementById('loading-cover')
        if (bookParam !== null) {
            const coverThumbnailUrl = new URL(standardUrl + bookParam + '/../' + 'cover-thumbnail.jpg')
            const coverUrl = new URL(standardUrl + bookParam + '/../' + 'cover.jpg')
            console.log(coverThumbnailUrl.href)
            const img = document.createElement('img')
            img.src = coverThumbnailUrl.href
            img.width = 350
            console.log(img)
            loadingCover.appendChild(img)
            const loadingMessage = document.createElement('span');
            loadingMessage.textContent = "Loading..."
            loadingMessage.className = 'loading-message'
            loadingCover.appendChild(loadingMessage)
            var thumbnailLink = document.createElement('link');
            thumbnailLink.rel = 'apple-touch-icon';
            thumbnailLink.href = coverThumbnailUrl.href;
            var coverLink = document.createElement('link');
            coverLink.rel = 'apple-touch-icon';
            coverLink.href = coverUrl.href;
            document.getElementsByTagName('head')[0].appendChild(thumbnailLink);
            document.getElementsByTagName('head')[0].appendChild(coverLink);
            function toTitleCase(str) {
                return str.replace(
                    /\w\S*/g,
                    function(txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                    }
                );
            }
            var title = document.querySelector("title");
            if (!title) {
                title = document.createElement('title');
                document.getElementsByTagName('head')[0].appendChild(title);
            }
            var urlTitle = toTitleCase(bookParam.slice(bookParam.indexOf("_")+1).replaceAll('-',' '))
            title.innerText = urlTitle;
        }
    </script>
</body>
<script src="./js/ebook.js"></script>
</html>
